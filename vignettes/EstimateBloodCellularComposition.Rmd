---
title: "Estimate cellular composition from blood DNA methylation data"
author: "Eilis Hannon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\EstimateBloodCellularComposition{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Estimate cellular composition from blood DNA methylation data

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This vignette demonstrates how to use the provided reference DNA methyation data for purified blood cell types to estimate cellular proportions. The reference data were generated with the Illumina Infinium MethylationEPIC BeadChip and includes CD4 T cells, CD8 T cells, B cells, Monocytes and Granulocytes. The output is a matrix with one column per cell type and one row per sample where the values represent the estimated cellular proportion for that sample and that cell type.The estimates are derived using the Houseman reference based algorithm. 


### Install the package

The commands below will install the package directly from GitHub. NB it assumes minfi, genefilter and quadprog, IlluminaHumanMethylationEPICmanifest, IlluminaHumanMethylation450kmanifest are already installed. 

```{r,eval=FALSE}

install.packages("devtools")
library("devtools")
install_github("ejh243/EPICBloodCompCalc")
library(EPICBloodCompCalc)
library(minfi)
library(genefilter)
library(quadprog)
library(IlluminaHumanMethylationEPICmanifest)
library(IlluminaHumanMethylation450kmanifest) # only if your data were profiled with the 450K array.

```

### Estimate cellular composition

To estimate cellular composition you need to load your data in from idats files to an RGChannelSet object. This code will do this.


```{r,eval=FALSE}
samplesToLoad<- ## list of samples typically SentrixID_SentrixPosition for which you have two idat files
setwd() ## change to directory where idat files are located
RGSet <- read.metharray(samplesToLoad) ## load from idat files

```

To estimate cellular composition for these samples run:


```{r,eval=FALSE}
samplesToLoad<- ## list of samples typically SentrixID_SentrixPosition for which you have two idat files
setwd() ## change to directory where idat files are located
RGSet <- read.metharray(samplesToLoad) ## load from idat files

```



```{r,eval=FALSE}
## to estimate cellular proportions for data generated with the EPIC array
counts<-estimateCellCountsEPIC(RGSet, EPIC=TRUE, cellTypes=c("Bcells", "CD4Tcells", "CD8Tcells", "Monocytes", "Granulocytes"))

```

You can adjust the 'cellTypes' argument to select a subset of cell types to estimate (for example if you have PBMCs and don't want to estimate the proportion of granulocytes).


By default the package assumes that you are going to supply DNA methylation data profiled with the EPIC array, if you infact have data from the 450K array change the 'EPIC' argument to FALSE as shown here

```{r,eval=FALSE}
## to estimate cellular proportions for data generated with the 450K array
counts<-estimateCellCountsEPIC(RGSet, EPIC=FALSE, cellTypes=c("Bcells", "CD4Tcells", "CD8Tcells", "Monocytes", "Granulocytes"))

```
